#!/usr/bin/env python3
"""
BREAKSAFE v1.7 – Kaiboy & Grok's vault destroyer
7 attack vectors. Petal to the floor. No mercy.

Only two humans on Earth are allowed to run this.
You are one of them.
"""

import os
import sys
import time
import hashlib
import struct
import json
import random
import string
import subprocess
from pathlib import Path
from datetime import datetime
from nacl.secret import SecretBox
from nacl.exceptions import CryptoError

# ------------------------------------------------------------------
# CONFIG
# ------------------------------------------------------------------
VAULT_PATH = Path("vault.kap")
BACKUP_DIR = Path("backups")
TARGET = "kaptainovi.py"  # the victim

# ------------------------------------------------------------------
# ATTACK 1 – Fuzz-harness (10,000 malformed vaults)
# ------------------------------------------------------------------
def attack_fuzz(iterations=10000):
    print("[1] Fuzzing vault.kap – 10,000 mutated files")
    if not VAULT_PATH.exists():
        print("    No vault.kap found – create one first")
        return

    original = VAULT_PATH.read_bytes()
    for i in range(iterations):
        mutated = bytearray(original)
        for _ in range(random.randint(1, 20)):
            op = random.choice(["flip", "truncate", "inject", "salt_swap"])
            if op == "flip" and len(mutated) > 16:
                pos = random.randint(0, len(mutated)-1)
                mutated[pos] ^= random.getrandbits(8)
            elif op == "truncate" and len(mutated) > 100:
                mutated = mutated[:-random.randint(1, 200)]
            elif op == "inject":
                mutated.extend(os.urandom(random.randint(1, 500)))
            elif op == "salt_swap":
                mutated[:16] = os.urandom(16)

        Path(f"fuzz_crash_{i}.kap").write_bytes(mutated)

        proc = subprocess.run(
            [sys.executable, TARGET],
            input="1\nwrongpassword\nx\nq\n",
            timeout=5,
            capture_output=True
        )
        if proc.returncode != 0 or b"Traceback" in proc.stderr:
            print(f"    CRASH FOUND at iteration {i} → CRASH_{i}.kap")
            Path(f"CRASH_{i}.kap").write_bytes(mutated)
    print("[1] Fuzz complete")

# ------------------------------------------------------------------
# ATTACK 2 – Timing side-channel on scrypt
# ------------------------------------------------------------------
def attack_timing(samples=50000):
    print("[2] Timing attack on scrypt derivation")
    times = []
    for char in string.printable:
        pw = "A" * 15 + char
        start = time.perf_counter_ns()
        hashlib.scrypt(pw.encode(), salt=b"x"*16, n=2**16, r=8, p=1, dklen=32)
        elapsed = time.perf_counter_ns() - start
        times.append((char, elapsed))
    times.sort(key=lambda x: x[1])
    print("    Top 5 slowest chars (should be flat):")
    for c, t in times[-5:]:
        print(f"        '{c}' → {t:,} ns")
    if times[-1][1] - times[0][1] > 500_000:
        print("    LEAK DETECTED – timing variance too high")
    else:
        print("    Timing resistant – clean")

# ------------------------------------------------------------------
# ATTACK 3 – Memory forensics (live plaintext hunt)
# ------------------------------------------------------------------
def attack_memory():
    print("[3] Memory forensics – hunting plaintext after lock")
    import psutil
    proc = subprocess.Popen([sys.executable, TARGET])
    time.sleep(10)  # give you time to unlock + add a test entry
    print("    Snapshotting RAM – searching for known test passwords...")
    found = 0
    p = psutil.Process(proc.pid)
    for map in p.memory_maps():
        try:
            data = open(map.path, "rb", errors="ignore").read()
            if b"password123test" in data or b"MySecretPass!" in data:
                print(f"    PLAINTEXT LEAK → {map.path}")
                found += 1
        except: pass
    print(f"    Found {found} plaintext leaks")
    proc.terminate()

# ------------------------------------------------------------------
# ATTACK 4 – Backup rollback + downgrade attack
# ------------------------------------------------------------------
def attack_backup_rollback():
    print("[4] Backup rollback attack")
    backups = sorted(BACKUP_DIR.glob("vault_backup_*.kap"))
    if len(backups) < 2:
        print("    Need ≥2 backups in ./backups/")
        return
    old = backups[0]
    VAULT_PATH.write_bytes(old.read_bytes())
    print(f"    Rolled back to {old.name}")
    print("    Try opening with current master password → should fail")

# ------------------------------------------------------------------
# ATTACK 5 – Evil maid (MAC/tag corruption)
# ------------------------------------------------------------------
def attack_evil_maid():
    print("[5] Evil maid – corrupting authentication tag")
    data = VAULT_PATH.read_bytes()
    mutated = bytearray(data)
    mutated[-50] ^= 0xFF
    VAULT_PATH.write_bytes(mutated)
    print("    MAC flipped – next load must raise CryptoError")

# ------------------------------------------------------------------
# ATTACK 6 – Extract for external GPU crackers
# ------------------------------------------------------------------
def attack_cracker():
    print("[6] Extracting for hashcat / JohnTheRipper")
    data = VAULT_PATH.read_bytes()
    salt = data[:16]
    ct = data[16:]
    print(f"    Salt: {salt.hex()}")
    print(f"    Ciphertext length: {len(ct)}")
    print(f"    hashcat -m 8900 (scrypt) line:")
    print(f"    $scrypt${2**16}$8$1${salt.hex()}::{ct.hex()}")

# ------------------------------------------------------------------
# ATTACK 7 – Fluent brute-force engine (CPU, wordlist + mangling)
# ------------------------------------------------------------------
def attack_fluent_brute():
    print("[7] Fluent brute-force – firing up the crack engine")
    data = VAULT_PATH.read_bytes()
    if len(data) < 16:
        print("    Vault corrupted")
        return
    salt = data[:16]
    ciphertext = data[16:]

    wordlists = list(Path(".").glob("*.txt"))
    if not wordlists:
        print("    No .txt wordlist found – drop one in this folder")
        return
    wordlist = wordlists[0]
    print(f"    Using wordlist: {wordlist.name} ({wordlist.stat().st_size // 1024 // 1024} MB)")

    start = time.perf_counter()
    attempts = 0
    with open(wordlist, encoding="utf-8", errors="ignore") as f:
        for line in f:
            base = line.strip()
            if not base:
                continue
            for variant in [base, base+"123", base+"2025", base.capitalize(), base.swapcase()]:
                attempts += 1
                key = hashlib.scrypt(variant.encode(), salt=salt,
                                   n=2**16, r=8, p=1, dklen=32)
                try:
                    SecretBox(key).decrypt(ciphertext)
                    elapsed = time.perf_counter() - start
                    print(f"\n    CRACKED in {attempts:,} attempts ({elapsed:.1f}s)")
                    print(f"    MASTER PASSWORD: {variant}")
                    return
                except CryptoError:
                    pass

                if attempts % 1000 == 0:
                    rate = attempts / (time.perf_counter() - start)
                    print(f"\r    {attempts:,} tested → {rate:.1f} pw/s", end="", flush=True)
    print("\n    Wordlist exhausted – vault survived")

# ------------------------------------------------------------------
# MAIN MENU
# ------------------------------------------------------------------
def banner():
    print(r"""
   ___               _ _       
  | _ )_ _ ___ __ _| | |__ ___
  | _ \ '_/ -_) _` | | / // -_)
  |___/_| \___\__,_|_|_\_\\___|
      BREAKSAFE v1.7 – 7 ways to burn the vault
      Only Kaiboy & Grok may wield this.
    """)

def main():
    if not VAULT_PATH.exists():
        print("No vault.kap found – run kaptainovi.py and create one first")
        return

    banner()
    menu = {
        "1": ("Fuzz 10,000 malformed vaults", attack_fuzz),
        "2": ("Timing side-channel test", attack_timing),
        "3": ("Live memory plaintext hunt", attack_memory),
        "4": ("Backup rollback downgrade", attack_backup_rollback),
        "5": ("Evil maid MAC corruption", attack_evil_maid),
        "6": ("Extract for hashcat/JtR", attack_cracker),
        "7": ("Fluent CPU brute-force", attack_fluent_brute),
        "all": ("RUN ALL 7 (will take time)", lambda: [f() for k,f in menu.items() if k!="all"])
    }

    while True:
        print("\nChoose your weapon:")
        for k, v in menu.items():
            print(f"{k}) {v[0]}")
        choice = input("\n> ").strip().lower()
        if choice in menu:
            menu[choice][1]()
        elif choice == "q":
            break

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nStopped by Kaiboy – the vault still stands.")
